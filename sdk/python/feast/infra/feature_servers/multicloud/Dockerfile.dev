FROM registry.access.redhat.com/ubi9/python-311:9.5

COPY --chown=default . ${APP_ROOT}/src

RUN mkdir -p ~/miniconda3 && \
    wget https://repo.anaconda.com/miniconda/Miniconda3-py311_24.9.2-0-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh && \
    bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3 && \
    rm ~/miniconda3/miniconda.sh
RUN source ~/miniconda3/bin/activate && \
    conda install -c conda-forge pyarrow=18.1 libarrow-flight && \
    conda clean

RUN pip install --no-cache-dir pip-tools
RUN make install-python-ci-dependencies

RUN npm install -S yarn
ENV PATH ${PATH}:${APP_ROOT}/src/node_modules/yarn/bin
RUN make build-ui

# modify permissions to support running with a random uid
RUN chmod g+w $(python -c "import feast.ui as ui; print(ui.__path__)" | tr -d "[']")/build/projects-list.json
