# Test dbt Project for Feast Integration Tests

This directory contains a minimal dbt project used for testing the Feast dbt integration functionality.

## Structure

```
test_dbt_project/
├── dbt_project.yml          # dbt project configuration
├── profiles.yml             # dbt connection profiles (using DuckDB for testing)
├── seeds/                   # CSV seed data for models
│   ├── driver_hourly_stats.csv
│   ├── customer_stats.csv
│   └── product_stats.csv
├── models/                  # dbt SQL models
│   ├── driver_features.sql
│   ├── customer_features.sql
│   ├── product_features.sql
│   └── schema.yml           # Model and column metadata
└── target/                  # dbt build output (generated, not committed)
    └── manifest.json        # Generated by dbt build
```

## Models

The test project includes 3 models with different configurations:

### 1. driver_features
- **Entity**: driver_id (INT64)
- **Tags**: feast, ml, driver
- **Features**: conv_rate, acc_rate, avg_daily_trips
- **Use case**: Tests INT32, INT64, and FLOAT64 types

### 2. customer_features
- **Entity**: customer_id (STRING)
- **Tags**: feast, ml, customer
- **Features**: total_orders, total_spent, avg_order_value
- **Use case**: Tests STRING entity and FLOAT64 features

### 3. product_features
- **Entity**: product_id (STRING)
- **Tags**: feast, recommendations (note: no 'ml' tag)
- **Features**: view_count, purchase_count, rating_avg
- **Use case**: Tests tag filtering and FLOAT32 type

## Pre-generated Manifest

The `target/manifest.json` file is **generated by dbt during CI runs**. The manifest is created when `dbt build` is executed in the GitHub Actions workflow. This allows the integration tests to:
- Test actual dbt compilation and build process
- Validate the generated manifest structure
- Ensure compatibility between dbt output and Feast import

The target directory is tracked in git with a `.gitkeep` file, but the manifest.json itself is excluded via `.gitignore` since it's generated during test execution.

## Testing Different Data Sources

The integration tests use this manifest to test all three Feast data source types:
- **BigQuery**: `feast_test_db.public.{model_name}`
- **Snowflake**: Database: `feast_test_db`, Schema: `public`, Table: `{model_name}`
- **File**: Path: `/data/{model_name}.parquet`

## Running Tests

The integration tests are located at:
```
sdk/python/tests/integration/dbt/test_dbt_integration.py
```

Run them with:
```bash
# First, generate the manifest by running dbt
cd sdk/python/tests/integration/dbt/test_dbt_project
dbt build

# Then run the tests
cd ../../..
pytest tests/integration/dbt/test_dbt_integration.py -v
```

In CI, the manifest is automatically generated by the GitHub Actions workflow before running tests.
