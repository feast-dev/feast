apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "feast-serving.fullname" . }}-application-config
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ template "feast-serving.name" . }}
    component: serving
    chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
data:
  application.yml: |
    feast:
      # GRPC service address for Feast Core
      # Feast Serving requires connection to Feast Core to retrieve and reload Feast metadata (e.g. FeatureSpecs, Store information)
      core-host: {{ .Values.core.host }}
      core-port: {{ .Values.core.port }}

      tracing:
        # If true, Feast will provide tracing data (using OpenTracing API) for various RPC method calls
        # which can be useful to debug performance issues and perform benchmarking
        enabled: {{ .Values.tracing.enabled }}
        {{- if .Values.tracing.enabled }}
        # Only Jaeger tracer is supported currently
        # https://opentracing.io/docs/supported-tracers/
        tracer-name: {{ .Values.tracing.tracerName }}
        # The service name identifier for the tracing data
        service-name: {{ .Values.tracing.serviceName }}
        {{ end }}

      store:
        # Path containing the store configuration for this serving store.
        config-path: /usr/share/feast/config/store.yml
        {{- if eq .Values.store.config.type "REDIS" }}
        # If serving redis, the redis pool max size
        redis-pool-max-size: {{ .Values.store.redisPool.maxSize }}
        # If serving redis, the redis pool max idle conns
        redis-pool-max-idle: {{ .Values.store.redisPool.maxIdle }}
        {{ end }}

      {{- if eq .Values.store.config.type "BIGQUERY" }}
      jobs:
        # job-staging-location specifies the URI to store intermediate files for batch serving.
        # Feast Serving client is expected to have read access to this staging location
        # to download the batch features.
        #
        # For example: gs://mybucket/myprefix
        # Please omit the trailing slash in the URI.
        staging-location: {{ .Values.store.jobs.stagingLocation }}
        # Type of store to store job metadata. This only needs to be set if the
        # serving store type is Bigquery.
        store-type: {{ .Values.store.jobs.storeType }}
        # Job store connection options. If the job store is redis, the redis instance host and port are required.
        store-options: 
{{ toYaml .Values.store.jobs.storeOptions | indent 10 }}
      {{ end }}

    grpc:
      # The port number Feast Serving GRPC service should listen on
      # It is set default to 6566 so it does not conflict with the GRPC server on Feast Core
      # which defaults to port 6565
      port: {{ .Values.service.grpc.targetPort }}

    server:
      # The port number on which the Tomcat webserver that serves REST API endpoints should listen
      # It is set by default to 8080 so it does not conflict with Tomcat webserver on Feast Core
      # if both Feast Core and Serving are running on the same machine
      port: {{ .Values.service.http.targetPort }}